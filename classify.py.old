import time

import pandas as pd
import requests
from datetime import datetime, timezone, timedelta

DELAY = timedelta(hours=1)

if __name__ == '__main__':
    while True:
        df = pd.read_csv('tokens_details.csv')
        df.drop_duplicates(subset=['pairAddress'], inplace=True)
        df['pairCreatedAt'] = pd.to_datetime(df['pairCreatedAt'])
        for i, row in df.iterrows():
            if row['worthy'] == -1:
                creation_time = row['pairCreatedAt']
                now = datetime.now()
                if now - creation_time >= DELAY:
                    cur = \
                    requests.get(f"https://api.dexscreener.com/latest/dex/pairs/solana/{row['pairAddress']}").json()[
                        'pair']
                    if (cur['fdv'] > row['fdv']) and (cur['liquidity']['usd'] > row['liquidity_usd']) and (
                            float(cur['priceUsd']) > row['priceUsd']) and (cur['fdv'] > 500 and cur['liquidity']['usd'] > 500):
                        print(f'fdv: {cur["fdv"]} liq_usd: {cur["liquidity"]["usd"]}')
                        print(f'{row["pairAddress"]} seems worthy')
                        df.at[i, 'worthy'] = 1
                    else:
                        print(f'{row["pairAddress"]} not worthy')
                        df.at[i, 'worthy'] = 0
                else:
                    print(f'{now - creation_time} {row["pairAddress"]}')
        df.to_csv('tokens_details.csv', index=False)
        print('Sleeping for 5min')
        time.sleep(600)
